<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>å±±å·¥é™¢æ ¡å›­æ•°å­—åœ°å›¾</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- å…ˆå¼•å…¥ Leaflet ä¸»åº“ -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <!-- geometryutil å¿…é¡»åœ¨ leaflet.js ä¹‹åã€leaflet.pm ä¹‹å‰ -->
    <script src="https://unpkg.com/leaflet-geometryutil"></script>
    <!-- å›½å†…å¤‡ç”¨ï¼š<script src=\"https://cdn.bootcdn.net/ajax/libs/leaflet-geometryutil/0.10.0/leaflet.geometryutil.min.js\"></script> -->

    <!-- å†å¼•å…¥æ’ä»¶å’Œå·¥å…·åº“ -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
    <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    <script src="https://unpkg.com/@turf/turf/turf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
    <!-- å¼•å…¥ leaflet.pm CSS/JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.pm@latest/dist/leaflet.pm.css" />
    <script src="https://unpkg.com/leaflet.pm@latest/dist/leaflet.pm.min.js"></script>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        body {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background: #fafbfc;
        }
        #main-container {
            display: flex;
            flex-direction: row;
            justify-content: center;
            align-items: flex-start;
            width: 100vw;
            max-width: 100vw;
            height: 80vh;
            min-height: 500px;
        }
        #map {
            height: 100%;
            min-height: 400px;
            width: 70vw;
            min-width: 500px;
            max-width: 900px;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        }
        #side-panel {
            width: 320px;
            min-width: 220px;
            margin-left: 18px;
            display: flex;
            flex-direction: column;
            align-items: stretch;
            justify-content: center;
            height: 100%;
            gap: 14px;
        }
        #chart {
            width: 100%;
            height: 260px;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            padding: 10px;
            margin-top: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #bufferBtn {
            margin: 12px 0 0 0;
            background: #43a047;
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 7px 18px;
            font-size: 15px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        #bufferBtn:hover { background: #2e7031; }
        #deleteBufferBtn {
            margin: 12px 0 0 0;
            background: #e5395b;
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 7px 18px;
            font-size: 15px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            display: none;
        }
        #deleteBufferBtn:hover { background: #ad1457; }
        @media (max-width: 900px) {
            #main-container { flex-direction: column; align-items: center; height: auto; }
            #map { width: 95vw; min-width: 0; max-width: 100vw; height: 350px; }
            #side-panel { width: 95vw; min-width: 0; margin-left: 0; }
        }
        /* åˆå¹¶å¼¹çª—æ ·å¼ */
        .modal {
          position: fixed; z-index: 2000; left: 0; top: 0; width: 100vw; height: 100vh;
          background: rgba(0,0,0,0.18); display: none; justify-content: center; align-items: center;
        }
        .modal-content {
          background: #fff; border-radius: 14px; box-shadow: 0 4px 24px rgba(0,0,0,0.10);
          padding: 24px 28px; min-width: 320px; max-width: 90vw; display: flex; flex-direction: column;
        }
        .modal-title {
          font-size: 18px; font-weight: bold; margin-bottom: 12px; color: #223354;
        }
        .modal-body {
          font-size: 15px; color: #444; margin-bottom: 16px;
        }
        .modal-footer {
          text-align: right;
        }
        .modal-btn {
          padding: 7px 28px; border: none; border-radius: 8px; font-size: 15px; font-weight: bold; cursor: pointer;
          margin-right: 8px; background: #295bff; color: #fff;
        }
        .modal-btn.cancel { background: #f2f4f8; color: #666; }
        /* æµ‹é‡labelæ ·å¼ */
        .measure-label-tooltip {
            background: rgba(255,255,255,0.95);
            color: #1976d2;
            border-radius: 6px;
            padding: 2px 10px;
            font-weight: bold;
            border: 1px solid #1976d2;
            font-size: 14px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.08);
        }
        
        /* è·¯ç”±æ§åˆ¶é¢æ¿æ ·å¼ */
        .leaflet-routing-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
            border: 1px solid #ddd;
            max-width: 320px;
            min-width: 280px;
        }
        
        .leaflet-routing-container h2 {
            background: #2196f3;
            color: white;
            margin: 0;
            padding: 12px 16px;
            font-size: 16px;
            border-radius: 8px 8px 0 0;
            text-align: center;
        }
        
        .leaflet-routing-container h3 {
            margin: 8px 0;
            font-size: 14px;
            color: #333;
        }
        
        .leaflet-routing-container input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            margin-bottom: 8px;
            box-sizing: border-box;
        }
        
        .leaflet-routing-container input:focus {
            outline: none;
            border-color: #2196f3;
            box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.2);
        }
        
        /* ç¡®å®šæŒ‰é’®æ ·å¼ */
        .routing-confirm-btn {
            width: 100%;
            background: #2196f3;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 10px 16px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            margin: 8px 0;
            transition: background 0.2s;
        }
        
        .routing-confirm-btn:hover {
            background: #1976d2;
        }
        
        .routing-confirm-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .leaflet-routing-container .leaflet-routing-alt {
            max-height: 200px;
            overflow-y: auto;
            border-top: 1px solid #eee;
            margin-top: 8px;
        }
        
        .leaflet-routing-container .leaflet-routing-alt h3 {
            background: #f5f5f5;
            padding: 8px 12px;
            margin: 0;
            font-size: 13px;
            color: #666;
        }
        
        .leaflet-routing-container .leaflet-routing-alt h4 {
            margin: 4px 0;
            font-size: 12px;
            color: #333;
            padding: 0 12px;
        }
        
        .leaflet-routing-container .leaflet-routing-alt h4:first-child {
            margin-top: 8px;
        }
        
        /* è·¯ç”±æŒ‰é’®æ ·å¼ */
        .routing-button:hover, .quick-routing-button:hover {
            background: #f0f0f0 !important;
            border-color: #2196f3 !important;
        }
        
        /* èµ·ç»ˆç‚¹æ ‡è®°æ ·å¼ */
        .start-marker, .end-marker {
            z-index: 1000;
        }
        
        /* è·¯ç”±çº¿è·¯æ ·å¼ */
        .leaflet-routing-alt-routes {
            background: #e3f2fd;
            border-radius: 4px;
            margin: 4px 8px;
            padding: 8px;
        }
        
        /* ç©ºé—´åˆ†ææŒ‰é’®æ ·å¼ */
        .analysis-btn {
            width: 100%;
            margin: 6px 0;
            background: #4caf50;
            color: #fff;
            border: none;
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .analysis-btn:hover {
            background: #388e3c;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .analysis-btn.active {
            background: #ff9800;
            box-shadow: 0 0 0 2px rgba(255, 152, 0, 0.3);
        }
        
        /* åˆ†æç»“æœé¢æ¿æ ·å¼ */
        .analysis-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
            padding: 15px;
            max-width: 300px;
            max-height: 400px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }
        .analysis-panel h4 {
            margin: 0 0 10px 0;
            color: #2196f3;
            font-size: 16px;
        }
        .analysis-panel .result-item {
            margin: 8px 0;
            padding: 8px;
            background: #f5f5f5;
            border-radius: 4px;
            font-size: 13px;
        }
        .analysis-panel .close-btn {
            position: absolute;
            top: 5px;
            right: 10px;
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: #666;
        }
        /* åœ°å›¾å·¦ä¸‹è§’å›¾ä¾‹æ§ä»¶æ ·å¼ */
        .leaflet-control.legend {
            background: white;
            padding: 12px 18px 12px 18px;
            border-radius: 10px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.10);
            border: 1px solid #ccc;
            font-size: 15px;
            min-width: 120px;
            max-width: 260px;
            word-break: break-all;
            white-space: normal;
            line-height: 1.7;
            margin-bottom: 18px;
        }
        .legend-title {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 8px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 4px;
        }
        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 7px;
            border: 2px solid #fff;
            box-shadow: 0 1px 2px rgba(0,0,0,0.08);
        }
        .legend-dot.canteen { background: #e91e63; }
        .legend-dot.dorm { background: #ff9800; }
        .legend-dot.teach { background: #4caf50; }
        .legend-dot.start-custom { background: #009688; border:2px solid #00695c; }
        .legend-dot.end-custom { background: #d32f2f; border:2px solid #b71c1c; }
        .legend-line { display:inline-block;width:28px;height:0;border-top:4px dashed #8e24aa;vertical-align:middle;margin:0 7px 0 0; }
        .legend-label { font-size: 14px; color: #333; }
    </style>
</head>
<body>
    <h2 style="text-align:center;">å±±å·¥é™¢æ ¡å›­æ•°å­—åœ°å›¾</h2>
    <div id="main-flex" style="display:flex;justify-content:center;align-items:flex-start;gap:32px;flex-wrap:wrap;margin-top:24px;">
      <div id="main-container">
        <div id="map"></div>
        <div id="side-panel">
          <button id="addMarkerBtn" style="margin:10px 0 0 0;background:#1976d2;color:#fff;border:none;border-radius:8px;padding:7px 18px;font-size:15px;cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,0.08);">+ æ·»åŠ æ ‡è®°</button>
          <button id="bufferBtn">ç¼“å†²åŒºåˆ†æ</button>
          <button id="deleteBufferBtn">åˆ é™¤ç¼“å†²åŒº</button>
          <button id="quickSetBtn">ğŸ“ å¿«é€Ÿè®¾ç½®èµ·ç»ˆç‚¹</button>
          <button id="clearRouteBtn" style="margin:6px 0 0 0;background:#ff9800;color:#fff;border:none;border-radius:8px;padding:7px 18px;font-size:15px;cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,0.08);">ğŸ—‘ï¸ æ¸…é™¤è·¯å¾„</button>
          <button id="siteAnalysisBtn" style="margin:12px 0 0 0;background:#4caf50;color:#fff;border:none;border-radius:8px;padding:7px 18px;font-size:15px;cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,0.08);">é€‰å€åˆ†æ</button>
          <div id="chart"></div>
          <div id="dormDeptChart" style="width:100%;min-width:0;height:260px;background:#fff;border-radius:12px;box-shadow:0 2px 12px rgba(0,0,0,0.08);padding:4px;margin-top:24px;"></div>
        </div>
      </div>
      <div id="feature-desc" style="width:540px;min-width:320px;max-width:560px;padding:12px 6px 8px 6px;background:#fff;border-radius:12px;box-shadow:0 2px 12px rgba(0,0,0,0.08);font-size:13.5px;color:#333;line-height:1.5;margin:0;display:flex;flex-direction:row;justify-content:space-between;gap:12px;text-align:left;">
        <div style="flex:1 1 0;min-width:0;">
          <b style="font-size:14px;display:block;margin-bottom:4px;">åœ°å›¾ä¸æ ‡è®°</b>
          <ul style="padding-left:14px;margin:0;">
            <li>åœ°å›¾æµè§ˆã€ç¼©æ”¾ã€ç‚¹é€‰</li>
            <li>æ·»åŠ /åˆ é™¤è‡ªå®šä¹‰æ ‡è®°</li>
            <li>ç¼“å†²åŒºåˆ†æ</li>
          </ul>
        </div>
        <div style="flex:1 1 0;min-width:0;">
          <b style="font-size:14px;display:block;margin-bottom:4px;">ç©ºé—´åˆ†æä¸ç»Ÿè®¡</b>
          <ul style="padding-left:14px;margin:0;">
            <li>æµ‹é‡å·¥å…·ï¼ˆè·ç¦»ã€é¢ç§¯ï¼‰</li>
            <li>ç»Ÿè®¡å›¾è¡¨ï¼ˆç”·å¥³æ¯”ä¾‹ã€å®¿èˆåˆ†å¸ƒï¼‰</li>
            <li>é€‰å€åˆ†æï¼ˆæ–°å»ºæ•™å­¦æ¥¼ç­‰å¤šå› ç´ å®šç‚¹ï¼‰</li>
            <li>æ”¯æŒç¼–è¾‘å’Œåˆ é™¤</li>
          </ul>
        </div>
        <div style="flex:1 1 0;min-width:0;">
          <b style="font-size:14px;display:block;margin-bottom:4px;">è·¯å¾„ä¸äº¤äº’</b>
          <ul style="padding-left:14px;margin:0;">
            <li>è·¯å¾„è§„åˆ’ï¼ˆè™šçº¿è·¯å¾„/æœ€çŸ­è·¯å¾„ï¼‰</li>
            <li>èµ·ç‚¹æ·±ç»¿ï¼Œç»ˆç‚¹æ·±çº¢</li>
            <li>ç•Œé¢è‡ªé€‚åº”ï¼Œæ§ä»¶/å¼¹çª—/å›¾ä¾‹ä¸­æ–‡</li>
          </ul>
        </div>
      </div>
    </div>
    <!-- é€šç”¨å¼¹çª— -->
    <div id="customModal" class="modal">
      <div class="modal-content">
        <div class="modal-title" id="modalTitle"></div>
        <div class="modal-body" id="modalBody"></div>
        <div class="modal-footer" id="modalFooter"></div>
      </div>
    </div>
    <!-- åˆ†æç»“æœé¢æ¿ -->
    <div id="analysisPanel" class="analysis-panel">
        <button class="close-btn" onclick="closeAnalysisPanel()">Ã—</button>
        <h4 id="analysisTitle">åˆ†æç»“æœ</h4>
        <div id="analysisContent"></div>
    </div>
    <!-- é€‰æ‹©å‡ºè¡Œæ–¹å¼å¼¹çª—ï¼ˆåˆå¹¶åˆ°é€šç”¨å¼¹çª—ï¼Œä¸å†å•ç‹¬ä¿ç•™ï¼‰ -->
    <script>
        // åˆå§‹åŒ–åœ°å›¾ï¼Œè®¾ç½®ä¸­å¿ƒç‚¹å’Œç¼©æ”¾çº§åˆ«
        var map = L.map('map').setView([35.0, 112.0], 16); // è¿™é‡Œçš„ç»çº¬åº¦è¯·æ›¿æ¢ä¸ºä½ å­¦æ ¡çš„å®é™…åæ ‡

        // æ·»åŠ åº•å›¾ï¼ˆOpenStreetMap æ˜äº®é£æ ¼ï¼‰
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            maxZoom: 19,
            attribution: 'Â© OpenStreetMap & CartoDB'
        }).addTo(map);

        // ç¤ºä¾‹ï¼šæ·»åŠ ä¸€ä¸ªæ ‡è®°ç‚¹
        L.marker([35.0, 112.0]).addTo(map)
            .bindPopup('è¿™é‡Œæ˜¯å±±å·¥é™¢')
            .openPopup();

        L.marker([35.0005, 112.0005]).addTo(map)
          .bindPopup('å›¾ä¹¦é¦†');

        // åŠ è½½æœ¬åœ° GeoJSON æ•°æ®ï¼ˆæ ¡å›­å»ºç­‘/èŒƒå›´ç­‰ï¼‰
        fetch('../data/campus.geojson')
          .then(response => response.json())
          .then(data => {
            L.geoJSON(data, {
              style: function(feature) {
                let color = "#3388ff";
                if (feature.properties && feature.properties.type) {
                  if (feature.properties.type === "æ•™å­¦æ¥¼") color = "#4caf50";
                  if (feature.properties.type === "å®¿èˆ") color = "#ff9800";
                  if (feature.properties.type === "é£Ÿå ‚") color = "#e91e63";
                }
                return {
                  color: color,
                  weight: 3,
                  fillColor: color,
                  fillOpacity: 0.4
                };
              },
              pointToLayer: function(feature, latlng) {
                return L.circleMarker(latlng, {
                  radius: 8,
                  fillColor: "#ff7800",
                  color: "#fff",
                  weight: 2,
                  opacity: 1,
                  fillOpacity: 0.9
                });
              },
              onEachFeature: function (feature, layer) {
                if (feature.properties && feature.properties.name) {
                  let popupContent = '<div style="font-weight:bold;font-size:18px;margin-bottom:8px;">' + feature.properties.name + '</div>';
                  if (feature.properties.type) {
                    popupContent += '<div style="color:#555;font-size:15px;margin-bottom:4px;">ç±»å‹ï¼š' + feature.properties.type + '</div>';
                  }
                  layer.bindPopup(popupContent);
                }
              }
            }).addTo(map);
          });

        // åŠ è½½å¹¶å±•ç¤ºdata/Export_Output.jsonä¸­çš„GeoJSONç‚¹æ•°æ®ï¼ˆè‡ªåŠ¨åˆ†ç±»å¹¶ç¾åŒ–ï¼‰
        fetch('../data/Export_Output.json')
          .then(response => response.json())
          .then(data => {
            // åˆ†ç±»é¢œè‰²å’Œå›¾ä¾‹
            const typeColor = {
              'é£Ÿå ‚': '#e5395b',
              'å®¿èˆ': '#ff9800',
              'æ•™å­¦æ¥¼': '#43a047',
              'å…¶ä»–': '#3388ff'
            };
            const typeName = ['é£Ÿå ‚', 'å®¿èˆ', 'æ•™å­¦æ¥¼', 'å…¶ä»–'];
            let typeSet = new Set();
            // åˆ†ç±»å‡½æ•°
            function getType(feature) {
              const f8 = feature.properties && feature.properties.Field8 ? feature.properties.Field8 : '';
              if (f8.includes('é¤é¥®') || f8.includes('é£Ÿå ‚') || f8.includes('é¤å…')) return 'é£Ÿå ‚';
              if (f8.includes('å®¿èˆ')) return 'å®¿èˆ';
              if (f8.includes('æ•™å­¦æ¥¼') || f8.includes('å­¦æ ¡') || f8.includes('å›¾ä¹¦é¦†')) return 'æ•™å­¦æ¥¼';
              return 'å…¶ä»–';
            }
            // å›¾å±‚
            window.geoLayer = L.geoJSON(data, {
              pointToLayer: function(feature, latlng) {
                const type = getType(feature);
                typeSet.add(type);
                return L.circleMarker(latlng, {
                  radius: 10,
                  fillColor: typeColor[type],
                  color: '#fff',
                  weight: 2,
                  opacity: 1,
                  fillOpacity: 0.95
                });
              },
              onEachFeature: function(feature, layer) {
                let popupContent = '';
                if (feature.properties && feature.properties.Field1) {
                  popupContent += '<div style="font-weight:bold;font-size:15px;margin-bottom:4px;line-height:1.2;">' + feature.properties.Field1 + '</div>';
                }
                if (feature.properties && feature.properties.Field2) {
                  popupContent += '<div style="color:#555;font-size:13px;">' + feature.properties.Field2 + '</div>';
                }
                layer.bindPopup(popupContent);
              }
            }).addTo(map);
            // è‡ªåŠ¨ç¼©æ”¾åˆ°æ‰€æœ‰ç‚¹
            map.fitBounds(window.geoLayer.getBounds());
            // åŠ¨æ€ç”Ÿæˆå›¾ä¾‹
            let legendHtml = '<b>å›¾ä¾‹</b><br>';
            typeName.forEach(type => {
              if (typeSet.has(type)) {
                legendHtml += `<span style=\"color:${typeColor[type]};font-size:18px;\">â—</span> ${type}<br>`;
              }
            });
          });

        // å¢åŠ æ¯”ä¾‹å°ºæ§ä»¶
        L.control.scale().addTo(map);

        // ç”¨æˆ·æ ‡è®°ç‚¹ç±»å‹å’Œé¢œè‰²
        const userTypeColor = {
          'é£Ÿå ‚': '#e5395b',
          'å®¿èˆ': '#ff9800',
          'æ•™å­¦æ¥¼': '#43a047',
          'å…¶ä»–': '#3388ff'
        };

        // ç”¨æˆ·æ·»åŠ çš„æ ‡è®°ç‚¹æ•°æ®
        var userMarkers = [];
        var userMarkerData = [];
        // ç§»é™¤åŸæœ‰ map.on('click', ...) çš„å…¨å±€ç›‘å¬
        // map.on('click', ...); // å·²åˆ é™¤

        // æ·»åŠ æ ‡è®°æ¨¡å¼
        var addMarkerMode = false;
        var addMarkerClickHandler = function(e) {
          var latlng = e.latlng;
          showInputDialog('è¯·è¾“å…¥æ ‡è®°ç‚¹åç§°ï¼ˆå¯é€‰ï¼‰ï¼š', {}, function(result) {
            if (result !== null) {
              var marker = L.circleMarker(latlng, {
                radius: 10,
                fillColor: userTypeColor[result.type],
                color: '#fff',
                weight: 2,
                opacity: 1,
                fillOpacity: 0.95
              }).addTo(map);
              userMarkers.push(marker);
              userMarkerData.push({name: result.name, type: result.type, marker: marker});
              updateMarkerPopup(userMarkers.length - 1);
              marker.on('drag', function() {}); // circleMarkerä¸æ”¯æŒæ‹–åŠ¨
            }
            // é€€å‡ºæ·»åŠ æ ‡è®°æ¨¡å¼
            map.off('click', addMarkerClickHandler);
            addMarkerMode = false;
            document.getElementById('addMarkerBtn').innerText = '+ æ·»åŠ æ ‡è®°';
            document.getElementById('addMarkerBtn').disabled = false;
          });
        };
        document.getElementById('addMarkerBtn').onclick = function() {
          if (addMarkerMode) return;
          addMarkerMode = true;
          this.innerText = 'è¯·åœ¨åœ°å›¾ä¸Šç‚¹é€‰ä½ç½®...';
          this.disabled = true;
          map.on('click', addMarkerClickHandler);
        };
        // æ›´æ–°å¼¹çª—å†…å®¹ï¼ˆé£æ ¼ç»Ÿä¸€ï¼‰
        function updateMarkerPopup(idx) {
          var marker = userMarkers[idx];
          var data = userMarkerData[idx];
          var popupContent = '';
          if (data.name) popupContent += '<div style="font-weight:bold;font-size:15px;margin-bottom:4px;line-height:1.2;">' + data.name + '</div>';
          popupContent += '<div style="color:#555;font-size:13px;margin-bottom:4px;">' + data.type + '</div>';
          popupContent += '<div style="display:flex;gap:6px;justify-content:center;">';
          popupContent += '<button onclick="window.modifyMarker(' + idx + ')" style="background:#43a047;color:#fff;border:none;border-radius:8px;padding:3px 14px;cursor:pointer;font-size:13px;transition:background 0.2s;line-height:1.2;" onmouseover="this.style.backgroundColor=\'#2e7031\'" onmouseout="this.style.backgroundColor=\'#43a047\'">ä¿®æ”¹</button>';
          popupContent += '<button onclick="window.deleteMarker(' + idx + ')" style="background:#e5395b;color:#fff;border:none;border-radius:8px;padding:3px 14px;cursor:pointer;font-size:13px;transition:background 0.2s;line-height:1.2;" onmouseover="this.style.backgroundColor=\'#ad1457\'" onmouseout="this.style.backgroundColor=\'#e5395b\'">åˆ é™¤</button>';
          popupContent += '</div>';
          marker.bindPopup(popupContent).openPopup();
        }
        window.deleteMarker = function(idx) {
          if (userMarkers[idx]) {
            map.removeLayer(userMarkers[idx]);
            userMarkers[idx] = null;
            userMarkerData[idx] = null;
          }
        };
        window.modifyMarker = function(idx) {
          if (userMarkers[idx]) {
            showInputDialog('è¯·è¾“å…¥æ–°çš„æ ‡è®°ç‚¹åç§°ï¼š', userMarkerData[idx], function(result) {
              if (result !== null) {
                userMarkerData[idx].name = result.name;
                userMarkerData[idx].type = result.type;
                userMarkers[idx].setStyle({fillColor: userTypeColor[result.type]});
                updateMarkerPopup(idx);
              }
            }, userMarkerData[idx].type);
          }
        };
        // è‡ªå®šä¹‰è¾“å…¥å¼¹çª—é€»è¾‘ï¼ˆæ”¯æŒç±»å‹é€‰æ‹©ï¼‰
        function showInputDialog(label, defaultValue, callback, defaultType) {
          document.getElementById('modalTitle').innerText = label;
          var input = document.getElementById('modalBody');
          var typeSel = document.getElementById('modalType');
          input.value = defaultValue && defaultValue.name ? defaultValue.name : '';
          typeSel.value = defaultValue && defaultValue.type ? defaultValue.type : (defaultType || 'å…¶ä»–');
          document.getElementById('customModal').style.display = 'flex';
          input.focus();
          function close(result) {
            document.getElementById('customModal').style.display = 'none';
            document.getElementById('modalOk').onclick = null;
            document.getElementById('modalCancel').onclick = null;
            input.onkeydown = null;
            callback(result);
          }
          document.getElementById('modalOk').onclick = function() {
            close({name: input.value, type: typeSel.value});
          };
          document.getElementById('modalCancel').onclick = function() {
            close(null);
          };
          input.onkeydown = function(e) {
            if (e.key === 'Enter') close({name: input.value, type: typeSel.value});
            if (e.key === 'Escape') close(null);
          };
        }

        // ç¼“å†²åŒºåˆ†æ
        var bufferLayer = null;
        document.getElementById('bufferBtn').onclick = function() {
          alert('è¯·åœ¨åœ°å›¾ä¸Šç‚¹å‡»é€‰æ‹©ç¼“å†²åŒºä¸­å¿ƒç‚¹');
          var onceClick = function(e) {
            var latlng = e.latlng;
            var radius = prompt('è¯·è¾“å…¥ç¼“å†²åŠå¾„ï¼ˆç±³ï¼‰ï¼š', 100);
            if (radius && !isNaN(radius)) {
              var pt = turf.point([latlng.lng, latlng.lat]);
              var buffered = turf.buffer(pt, Number(radius), {units: 'meters'});
              if (bufferLayer) map.removeLayer(bufferLayer);
              bufferLayer = L.geoJSON(buffered, {
                style: {color:'#e5395b', fillColor:'#e57373', fillOpacity:0.25, weight:2}
              }).addTo(map);
              document.getElementById('deleteBufferBtn').style.display = 'block';
            }
            map.off('click', onceClick);
          };
          map.on('click', onceClick);
        };
        document.getElementById('deleteBufferBtn').onclick = function() {
          if (bufferLayer) {
            map.removeLayer(bufferLayer);
            bufferLayer = null;
          }
          document.getElementById('deleteBufferBtn').style.display = 'none';
        };

        // ç»Ÿè®¡å›¾è¡¨ï¼ˆEChartsæ¼”ç¤ºï¼‰
        var chartDom = document.getElementById('chart');
        var myChart = echarts.init(chartDom);
        var option = {
          title: { text: 'å®¿èˆæ¥¼ç”·å¥³æ¯”ä¾‹', left: 'center', top: 10, textStyle: {fontSize: 18} },
          tooltip: { trigger: 'item', formatter: '{b}: {c}äºº ({d}%)' },
          legend: { orient: 'vertical', left: 'left', data: ['ç”·ç”Ÿ', 'å¥³ç”Ÿ'] },
          series: [
            {
              name: 'äººæ•°',
              type: 'pie',
              radius: '60%',
              data: [
                { value: 320, name: 'ç”·ç”Ÿ' },
                { value: 280, name: 'å¥³ç”Ÿ' }
              ],
              emphasis: {
                itemStyle: { shadowBlur: 10, shadowOffsetX: 0, shadowColor: 'rgba(0, 0, 0, 0.5)' }
              },
              label: { formatter: '{b}: {c}äºº ({d}%)' }
            }
          ]
        };
        myChart.setOption(option);

        // å„ç³»å­¦ç”Ÿå®¿èˆæ¥¼äººå£åˆ†å¸ƒå›¾ï¼ˆEChartsæŸ±çŠ¶å›¾ï¼‰
        var dormDeptDom = document.getElementById('dormDeptChart');
        var dormDeptChart = echarts.init(dormDeptDom);
        var dormDeptOption = {
          title: { text: 'å„ç³»å­¦ç”Ÿå®¿èˆæ¥¼äººå£åˆ†å¸ƒ', left: 'center', top: 10, textStyle: {fontSize: 18} },
          tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
          grid: { left: 40, right: 20, bottom: 48, top: 50 },
          xAxis: { type: 'category', data: ['è®¡ç®—æœº', 'åœŸæœ¨', 'æœºæ¢°', 'ç”µæ°”', 'ç®¡ç†', 'è‰ºæœ¯'], axisLabel: { fontSize: 13, interval: 0 } },
          yAxis: { type: 'value', name: 'äººæ•°', axisLabel: { fontSize: 13 } },
          series: [{
            name: 'äººæ•°',
            type: 'bar',
            data: [120, 98, 135, 110, 80, 60],
            itemStyle: { color: '#43a047', borderRadius: [6,6,0,0] },
            label: { show: true, position: 'top', fontSize: 13 }
          }]
        };
        dormDeptChart.setOption(dormDeptOption);
        // å¼ºåˆ¶åˆæ¬¡resizeï¼Œé˜²æ­¢è¢«è£å‰ª
        dormDeptChart.resize();
        // è‡ªé€‚åº”çª—å£å¤§å°
        window.addEventListener('resize', function() {
          dormDeptChart.resize();
        });

        // æ±‰åŒ– leaflet.pm å·¥å…·æ ï¼ˆaddControlså‰ï¼Œå»ºè®®é”å®š@latestç‰ˆæœ¬ï¼‰
        if (window.L && window.L.PM && window.L.PM.setLang) {
          L.PM.setLang('zh', {
            tooltips: {
              placeMarker: 'ç‚¹å‡»åœ°å›¾æ·»åŠ ç‚¹',
              firstVertex: 'ç‚¹å‡»åœ°å›¾æ·»åŠ ç¬¬ä¸€ä¸ªç‚¹',
              continueLine: 'ç‚¹å‡»åœ°å›¾ç»§ç»­ç”»çº¿',
              finishLine: 'åŒå‡»æˆ–ç‚¹å‡»æœ€åä¸€ä¸ªç‚¹å®Œæˆ',
              finishPoly: 'åŒå‡»æˆ–ç‚¹å‡»ç¬¬ä¸€ä¸ªç‚¹å®Œæˆ',
              finishRect: 'ç‚¹å‡»å®Œæˆ',
              finishCircle: 'ç‚¹å‡»å®Œæˆ',
              finishCut: 'ç‚¹å‡»å®Œæˆè£å‰ª',
              edit: 'æ‹–åŠ¨ç‚¹ç¼–è¾‘å½¢çŠ¶',
              drag: 'æ‹–åŠ¨å›¾å½¢',
              cut: 'ç‚¹å‡»åœ°å›¾ç»˜åˆ¶è£å‰ªåŒºåŸŸ',
              removal: 'ç‚¹å‡»å›¾å½¢åˆ é™¤'
            },
            actions: {
              finish: 'å®Œæˆ',
              cancel: 'å–æ¶ˆ',
              removeLastVertex: 'æ’¤é”€ä¸Šä¸€ä¸ªç‚¹'
            },
            buttonTitles: {
              drawMarkerButton: 'æ·»åŠ æ ‡è®°ç‚¹',
              drawPolyButton: 'ç»˜åˆ¶å¤šè¾¹å½¢',
              drawLineButton: 'ç»˜åˆ¶æŠ˜çº¿',
              drawCircleButton: 'ç»˜åˆ¶åœ†',
              drawRectButton: 'ç»˜åˆ¶çŸ©å½¢',
              editButton: 'ç¼–è¾‘å›¾å½¢',
              dragButton: 'æ‹–åŠ¨å›¾å½¢',
              cutButton: 'è£å‰ªå›¾å½¢',
              removalButton: 'åˆ é™¤å›¾å½¢'
            }
          });
          map.pm.setLang('zh');
        }
        // é›†æˆ leaflet.pm æµ‹é‡å·¥å…·ï¼ˆæ”¯æŒæµ‹è·ã€æµ‹é¢ç§¯ã€ç¼–è¾‘ã€åˆ é™¤ï¼Œç•Œé¢å…¨ä¸­æ–‡ï¼‰
        map.pm.addControls({
          position: 'topright',
          drawCircle: false,
          drawMarker: false,
          drawCircleMarker: false,
          drawPolyline: true,
          drawPolygon: true,
          editMode: true,
          dragMode: true,
          cutPolygon: false,
          removalMode: true
        });
        // ä¿®æ­£é¢ç§¯å¼¹çª—æ˜¾ç¤ºé€»è¾‘
        map.on('pm:create', function(e) {
          clearMeasureLabels();
          var layer = e.layer;
          if (layer instanceof L.Polyline && !(layer instanceof L.Polygon)) {
            var len = L.GeometryUtil.length(layer);
            layer.bindPopup('æ€»é•¿åº¦ï¼š' + formatLength(len)).openPopup();
          } else if (layer instanceof L.Polygon) {
            var area = getPolygonArea(layer.getLatLngs()[0]);
            layer.bindPopup('æ€»é¢ç§¯ï¼š' + formatArea(area)).openPopup();
            addMeasureLabel(layer);
          }
        });
        map.on('pm:edit', function(e) {
          if (e.layer && e.layer.eachLayer) {
            e.layer.eachLayer(function(l) { if (l instanceof L.Polygon) addMeasureLabel(l); });
          } else if (e.layer && e.layer instanceof L.Polygon) {
            addMeasureLabel(e.layer);
          }
        });
        map.on('pm:remove', function(e) {
          if (e.layer instanceof L.Polygon) {
            removeMeasureLabel(e.layer);
          }
        });

        // ========== æµ‹é‡labelåŠŸèƒ½ ========== //
        // å·¥å…·å‡½æ•°ï¼šè®¡ç®—æŠ˜çº¿ä¸­ç‚¹
        function getPolylineMidLatLng(latlngs) {
          let total = 0, segLens = [];
          for (let i = 1; i < latlngs.length; i++) {
            let seg = latlngs[i-1].distanceTo(latlngs[i]);
            segLens.push(seg);
            total += seg;
          }
          let half = total / 2, acc = 0;
          for (let i = 1; i < latlngs.length; i++) {
            if (acc + segLens[i-1] >= half) {
              let remain = half - acc;
              let p1 = latlngs[i-1], p2 = latlngs[i];
              let ratio = remain / segLens[i-1];
              return L.latLng(
                p1.lat + (p2.lat - p1.lat) * ratio,
                p1.lng + (p2.lng - p1.lng) * ratio
              );
            }
            acc += segLens[i-1];
          }
          return latlngs[0];
        }
        // turf.js è®¡ç®—å¤šè¾¹å½¢é¢ç§¯ï¼ˆå¹³æ–¹ç±³ï¼‰
        function getPolygonArea(latlngs) {
          const coords = latlngs.map(ll => [ll.lng, ll.lat]);
          if (coords.length > 0 && (coords[0][0] !== coords[coords.length-1][0] || coords[0][1] !== coords[coords.length-1][1])) {
            coords.push(coords[0]);
          }
          const polygon = turf.polygon([[...coords]]);
          return turf.area(polygon);
        }
        // å­˜å‚¨æµ‹é‡labelï¼Œä¾¿äºåç»­æ¸…ç†/æ›´æ–°
        let measureLabels = new Map();
        function getPolygonCentroid(latlngs) {
          let pts = latlngs[0] ? latlngs[0] : latlngs;
          if (!pts || pts.length < 3) return null; // æ–°å¢ï¼šé¡¶ç‚¹æ•°ä¸è¶³ä¸è®¡ç®—
          let x = 0, y = 0, area = 0;
          for (let i = 0, j = pts.length - 1; i < pts.length; j = i++) {
            let f = pts[j].lat * pts[i].lng - pts[i].lat * pts[j].lng;
            x += (pts[j].lat + pts[i].lat) * f;
            y += (pts[j].lng + pts[i].lng) * f;
            area += f;
          }
          area = area / 2;
          if (area === 0) return pts[0];
          x = x / (6 * area);
          y = y / (6 * area);
          return L.latLng(x, y);
        }
        function addMeasureLabel(layer) {
          removeMeasureLabel(layer);
          let tooltip, text = '';
          if (layer instanceof L.Polygon) {
            let latlngs = layer.getLatLngs();
            if (!latlngs[0] || latlngs[0].length < 3) return; // æ–°å¢ï¼šé¡¶ç‚¹æ•°ä¸è¶³ä¸æ·»åŠ æ ‡ç­¾
            let area = getPolygonArea(latlngs[0]);
            text = 'æ€»é¢ç§¯ï¼š' + formatArea(area);
            let centroid = getPolygonCentroid(latlngs[0]);
            if (!centroid) return; // æ–°å¢ï¼šè´¨å¿ƒæ— æ•ˆä¸æ·»åŠ 
            tooltip = L.tooltip({permanent:true, direction:'center', className:'measure-label-tooltip'}).setContent(text).setLatLng(centroid);
            tooltip.addTo(map);
          }
          if (tooltip) measureLabels.set(layer._leaflet_id, tooltip);
        }
        function removeMeasureLabel(layer) {
          let t = measureLabels.get(layer._leaflet_id);
          if (t) { map.removeLayer(t); measureLabels.delete(layer._leaflet_id); }
        }
        function updateAllMeasureLabels() {
          map.eachLayer(function(layer) {
            if (layer.pm && (layer instanceof L.Polyline || layer instanceof L.Polygon)) {
              addMeasureLabel(layer);
            }
          });
        }
        // ç›‘å¬æµ‹é‡åˆ›å»º
        map.on('pm:create', function(e) {
          addMeasureLabel(e.layer);
        });
        // ç›‘å¬æµ‹é‡ç¼–è¾‘
        map.on('pm:edit', function(e) {
          if (e.layer && e.layer.eachLayer) {
            e.layer.eachLayer(function(l) { addMeasureLabel(l); });
          } else if (e.layer) {
            addMeasureLabel(e.layer);
          }
        });
        // ç›‘å¬æµ‹é‡åˆ é™¤
        map.on('pm:remove', function(e) {
          removeMeasureLabel(e.layer);
        });
        // é¡µé¢åŠ è½½åè‡ªåŠ¨ä¸ºå·²æœ‰æµ‹é‡å›¾å±‚åŠ label
        setTimeout(updateAllMeasureLabels, 800);

        // è‡ªåŠ¨ç”Ÿæˆåœ°ååˆ°ç»çº¬åº¦æ˜ å°„è¡¨ï¼ˆç”±GeoJSONæ•°æ®ç”Ÿæˆï¼‰
        const campusPlaceMap = {
          'å¼ äº®éº»è¾£çƒ«(å±±è¥¿å·¥ç¨‹æŠ€æœ¯å­¦é™¢åº—)': [37.881778584000074, 113.59888782500002],
          'å±±è¥¿å·¥ç¨‹æŠ€æœ¯å­¦é™¢å­¦èšè‹‘é¤å…': [37.88486309700005, 113.60156442000005],
          'ç¾é£Ÿç¾å®¢ç ‚é”…èœåœŸè±†ç²‰åº—(å­¦é™¢åº—)': [37.88222413900007, 113.6003247970001],
          'å±±è¥¿å·¥ç¨‹æŠ€æœ¯å­¦é™¢æ¢¦æ¸…è‹‘é¤å…': [37.88182363900006, 113.59874581200006],
          'å­¦èšè‹‘æ°´æœåº—': [37.88461574300004, 113.6022353830001],
          'èœé¸Ÿé©¿ç«™(é•¿æ³‰å—è·¯åº—)': [37.88209618700006, 113.60014281500003],
          'æ ¡å›­æ–‡å°åº—': [37.88189319900005, 113.60001784000008],
          'å±±è¥¿å·¥ç¨‹æŠ€æœ¯å­¦é™¢ä½“è‚²é¦†': [37.88263412100008, 113.60055474300009],
          'å±±è¥¿å·¥ç¨‹æŠ€æœ¯å­¦é™¢ä¸œä½“è‚²åœº(è¶³çƒåœº)': [37.88317458800003, 113.60200658000008],
          'ä¸œæ“åœº(è¶³çƒåœº)': [37.88309261000006, 113.60192759800009],
          'å±±è¥¿å·¥ç¨‹æŠ€æœ¯å­¦é™¢å´‡å¾·å…¬å¯“': [37.88576199400006, 113.60214625700007],
          'å±±è¥¿å·¥ç¨‹æŠ€æœ¯å­¦é™¢æ¶¦æ³½å›­': [37.88105412600004, 113.59980893900001],
          'æ€è´¤æ¥¼': [37.88143719000004, 113.60218476700004],
          'å±±è¥¿å·¥ç¨‹æŠ€æœ¯å­¦é™¢å°šèƒ½å…¬å¯“': [37.88266179900006, 113.59872171100005],
          'ç ”é€”è€ƒç ”': [37.88555712500005, 113.6017833190001],
          'å±±è¥¿å·¥ç¨‹æŠ€æœ¯å­¦é™¢å›¾ä¹¦é¦†äºŒå·æ¥¼': [37.880813371000045, 113.59899994600005],
          'å±±è¥¿å·¥ç¨‹æŠ€æœ¯å­¦é™¢-å®éªŒå®è®­ä¸­å¿ƒ3å·': [37.88076745800004, 113.60132992500007],
          'å­¦é™¢åœè½¦åœº': [37.881446571000026, 113.59874585700004]
        };

        // åœ°ååˆ«åæ˜ å°„ï¼ˆå¯è‡ªè¡Œæ‰©å……ï¼‰
        const campusPlaceAlias = {
          'æ¢¦æ¸…è‹‘é¤å…': 'å±±è¥¿å·¥ç¨‹æŠ€æœ¯å­¦é™¢æ¢¦æ¸…è‹‘é¤å…',
          'å­¦èšè‹‘é¤å…': 'å±±è¥¿å·¥ç¨‹æŠ€æœ¯å­¦é™¢å­¦èšè‹‘é¤å…',
          'ä¸œä½“è‚²åœº': 'å±±è¥¿å·¥ç¨‹æŠ€æœ¯å­¦é™¢ä¸œä½“è‚²åœº(è¶³çƒåœº)',
          'å´‡å¾·å…¬å¯“': 'å±±è¥¿å·¥ç¨‹æŠ€æœ¯å­¦é™¢å´‡å¾·å…¬å¯“',
          'æ¶¦æ³½å›­': 'å±±è¥¿å·¥ç¨‹æŠ€æœ¯å­¦é™¢æ¶¦æ³½å›­',
          'å°šèƒ½å…¬å¯“': 'å±±è¥¿å·¥ç¨‹æŠ€æœ¯å­¦é™¢å°šèƒ½å…¬å¯“',
          'å›¾ä¹¦é¦†äºŒå·æ¥¼': 'å±±è¥¿å·¥ç¨‹æŠ€æœ¯å­¦é™¢å›¾ä¹¦é¦†äºŒå·æ¥¼',
          'å®éªŒå®è®­ä¸­å¿ƒ3å·': 'å±±è¥¿å·¥ç¨‹æŠ€æœ¯å­¦é™¢-å®éªŒå®è®­ä¸­å¿ƒ3å·',
          // å¯ç»§ç»­æ‰©å……
        };

        // æ”¯æŒæ¨¡ç³ŠåŒ¹é…å’Œåˆ«åçš„åœ°åè§£æ
        function resolvePlace(name, callback) {
          // å…ˆæŸ¥åˆ«å
          if (campusPlaceAlias[name]) name = campusPlaceAlias[name];
          // ç²¾ç¡®åŒ¹é…
          if (campusPlaceMap[name]) {
            callback({lat: campusPlaceMap[name][0], lng: campusPlaceMap[name][1]});
            return;
          }
          // æ¨¡ç³ŠåŒ¹é…ï¼ˆåŒ…å«å…³ç³»ï¼Œå¿½ç•¥å¤§å°å†™ï¼‰
          let found = null;
          let lower = name.toLowerCase();
          for (let key in campusPlaceMap) {
            if (key.toLowerCase().includes(lower)) {
              found = key;
              break;
            }
          }
          if (found) {
            callback({lat: campusPlaceMap[found][0], lng: campusPlaceMap[found][1]});
            return;
          }
          // æ¨èæœ€æ¥è¿‘çš„åœ°å
          let suggestions = Object.keys(campusPlaceMap).filter(k => {
            let lkey = k.toLowerCase();
            return lkey.indexOf(lower[0]) !== -1 || lkey.indexOf(lower.slice(-1)) !== -1;
          });
          if (suggestions.length > 0) {
            alert('æœªæ‰¾åˆ°è¯¥åœ°åï¼Œæ‚¨å¯ä»¥è¯•è¯•ï¼š\n' + suggestions.slice(0,5).join('\n'));
          } else {
            alert('æœªæ‰¾åˆ°è¯¥åœ°åï¼Œè¯·ç”¨åœ°å›¾ç‚¹é€‰æˆ–è¾“å…¥æ ‡å‡†åœ°åã€‚');
          }
          callback(null);
        }

        // ========== åœ°åè‡ªåŠ¨è¡¥å…¨ä¸‹æ‹‰å»ºè®® ========== //
        function createAutocomplete(input) {
          let acList = document.createElement('div');
          acList.className = 'autocomplete-list';
          acList.style.position = 'absolute';
          acList.style.zIndex = 9999;
          acList.style.background = '#fff';
          acList.style.border = '1px solid #ddd';
          acList.style.borderRadius = '6px';
          acList.style.boxShadow = '0 2px 8px rgba(0,0,0,0.08)';
          acList.style.maxHeight = '180px';
          acList.style.overflowY = 'auto';
          acList.style.minWidth = input.offsetWidth + 'px';
          acList.style.fontSize = '15px';
          acList.style.display = 'none';
          document.body.appendChild(acList);

          function updateList() {
            let val = input.value.trim().toLowerCase();
            if (!val) { acList.style.display = 'none'; return; }
            let allNames = Object.keys(campusPlaceMap).concat(Object.keys(campusPlaceAlias));
            let shown = [];
            for (let name of allNames) {
              if (name.toLowerCase().includes(val) && shown.indexOf(name) === -1) shown.push(name);
              if (shown.length >= 8) break;
            }
            if (shown.length === 0) { acList.style.display = 'none'; return; }
            acList.innerHTML = '';
            shown.forEach((name, idx) => {
              let item = document.createElement('div');
              item.className = 'autocomplete-item';
              item.style.padding = '7px 14px';
              item.style.cursor = 'pointer';
              item.style.borderBottom = '1px solid #f0f0f0';
              item.innerHTML = name;
              item.onmousedown = function(e) {
                e.preventDefault();
                input.value = name;
                acList.style.display = 'none';
                input.dispatchEvent(new Event('input'));
              };
              acList.appendChild(item);
            });
            let rect = input.getBoundingClientRect();
            acList.style.left = rect.left + 'px';
            acList.style.top = (rect.bottom + window.scrollY) + 'px';
            acList.style.minWidth = rect.width + 'px';
            acList.style.display = 'block';
          }

          input.addEventListener('input', updateList);
          input.addEventListener('focus', updateList);
          input.addEventListener('blur', function() { setTimeout(()=>acList.style.display='none', 150); });
          // é”®ç›˜ä¸Šä¸‹é€‰æ‹©
          let idx = -1;
          input.addEventListener('keydown', function(e) {
            let items = acList.querySelectorAll('.autocomplete-item');
            if (acList.style.display === 'block' && items.length > 0) {
              if (e.key === 'ArrowDown') {
                idx = (idx + 1) % items.length;
                items.forEach((it,i)=>it.style.background=i===idx?'#e3f2fd':'#fff');
                e.preventDefault();
              } else if (e.key === 'ArrowUp') {
                idx = (idx - 1 + items.length) % items.length;
                items.forEach((it,i)=>it.style.background=i===idx?'#e3f2fd':'#fff');
                e.preventDefault();
              } else if (e.key === 'Enter' && idx >= 0) {
                input.value = items[idx].innerText;
                acList.style.display = 'none';
                input.dispatchEvent(new Event('input'));
                e.preventDefault();
              }
            }
          });
        }
        // è‡ªåŠ¨ä¸ºè·¯å¾„è§„åˆ’é¢æ¿çš„è¾“å…¥æ¡†å¯ç”¨è‡ªåŠ¨è¡¥å…¨
        setTimeout(function() {
          document.querySelectorAll('.leaflet-routing-container input').forEach(createAutocomplete);
        }, 1200);
        // è‡ªåŠ¨è¡¥å…¨æ ·å¼
        const style = document.createElement('style');
        style.innerHTML = `.autocomplete-list::-webkit-scrollbar{width:6px;background:#f5f5f5}.autocomplete-list::-webkit-scrollbar-thumb{background:#e0e0e0;border-radius:3px}.autocomplete-item:hover{background:#e3f2fd}`;
        document.head.appendChild(style);

        // ========== è™šçº¿è·¯å¾„ç»˜åˆ¶ ========== //
        let tempRouteLine = null;
        let tempRouteLabel = null;
        let tempStartMarker = null;
        let tempEndMarker = null;
        let isQuickSetting = false;
        
        function drawTempRouteLine(start, end, mode) {
          if (tempRouteLine) { map.removeLayer(tempRouteLine); tempRouteLine = null; }
          if (tempRouteLabel) { map.removeLayer(tempRouteLabel); tempRouteLabel = null; }
          if (roadPathLine) { map.removeLayer(roadPathLine); roadPathLine = null; }
          tempRouteLine = L.polyline([start, end], {
            color: '#8e24aa', // ç´«è‰²
            weight: 5,
            opacity: 0.8,
            dashArray: '10 10',
            lineCap: 'round',
            lineJoin: 'round'
          }).addTo(map);
          // è®¡ç®—è·ç¦»å¹¶æ˜¾ç¤ºæ ‡ç­¾
          const dist = map.distance(start, end);
          let text = (mode ? mode + ' | ' : '') + (dist < 1000 ? `å…¨é•¿ï¼š${dist.toFixed(1)} ç±³` : `å…¨é•¿ï¼š${(dist/1000).toFixed(3)} åƒç±³`);
          // è®¡ç®—ä¸­ç‚¹
          const mid = L.latLng((start.lat+end.lat)/2, (start.lng+end.lng)/2);
          tempRouteLabel = L.tooltip({permanent:true, direction:'center', className:'measure-label-tooltip'})
            .setContent(text).setLatLng(mid).addTo(map);
          // æ–°å¢ï¼šæ˜¾ç¤ºæ²¿é“è·¯æœ€çŸ­è·¯å¾„
          showRoadPath(start, end);
          // èµ·ç‚¹ç»ˆç‚¹markeré¢œè‰²
          if (tempStartMarker) map.removeLayer(tempStartMarker);
          if (tempEndMarker) map.removeLayer(tempEndMarker);
          tempStartMarker = L.marker(start, {
            icon: L.divIcon({
              className: 'start-marker',
              html: '<div style="background:#009688;width:20px;height:20px;border-radius:50%;border:3px solid #fff;box-shadow:0 2px 6px rgba(0,0,0,0.3);"></div>',
              iconSize: [20, 20],
              iconAnchor: [10, 10]
            })
          }).addTo(map).bindPopup('èµ·ç‚¹').openPopup();
          tempEndMarker = L.marker(end, {
            icon: L.divIcon({
              className: 'end-marker',
              html: '<div style="background:#d32f2f;width:20px;height:20px;border-radius:50%;border:3px solid #fff;box-shadow:0 2px 6px rgba(0,0,0,0.3);"></div>',
              iconSize: [20, 20],
              iconAnchor: [10, 10]
            })
          }).addTo(map).bindPopup('ç»ˆç‚¹').openPopup();
        }
        
        function clearQuickRoute() {
          if (tempRouteLine) { map.removeLayer(tempRouteLine); tempRouteLine = null; }
          if (tempRouteLabel) { map.removeLayer(tempRouteLabel); tempRouteLabel = null; }
          if (tempStartMarker) { map.removeLayer(tempStartMarker); tempStartMarker = null; }
          if (tempEndMarker) { map.removeLayer(tempEndMarker); tempEndMarker = null; }
          isQuickSetting = false;
        }

        // å¿«é€Ÿè®¾ç½®èµ·ç»ˆç‚¹åŠŸèƒ½
        function initQuickSetButton() {
          var quickSetBtn = document.getElementById('quickSetBtn');
          if (quickSetBtn) {
            quickSetBtn.onclick = function() {
              if (isQuickSetting) {
                // å¦‚æœæ­£åœ¨è®¾ç½®ä¸­ï¼Œå–æ¶ˆè®¾ç½®
                clearQuickRoute();
                map.off('click', onMapClick);
                // è§£ç»‘æ‰€æœ‰ç‚¹çš„ä¸´æ—¶äº‹ä»¶
                if(window.geoLayer) window.geoLayer.eachLayer(l=>l.off('click', onMarkerClick));
                if(window.userMarkers) window.userMarkers.forEach(m=>m && m.off('click', onMarkerClick));
                quickSetBtn.textContent = 'ğŸ“ å¿«é€Ÿè®¾ç½®èµ·ç»ˆç‚¹';
                quickSetBtn.style.background = '#1976d2';
                alert('å·²å–æ¶ˆå¿«é€Ÿè®¾ç½®');
                return;
              }
              
              // å¼€å§‹è®¾ç½®
              isQuickSetting = true;
              quickSetBtn.textContent = 'âŒ å–æ¶ˆè®¾ç½®';
              quickSetBtn.style.background = '#f44336';
              alert('è¯·åœ¨åœ°å›¾ä¸Šä¾æ¬¡ç‚¹å‡»èµ·ç‚¹å’Œç»ˆç‚¹ï¼ˆæ”¯æŒæ­¥è¡Œã€éª‘è¡Œæˆ–å¼€è½¦ï¼Œä»…ä¸ºæ¨¡æ‹Ÿç›´çº¿è·ç¦»ï¼Œä¸ä»£è¡¨çœŸå®é“è·¯å¯¼èˆªï¼‰\nç‚¹å‡»ç¬¬ä¸€ä¸ªç‚¹è®¾ä¸ºèµ·ç‚¹ï¼ˆç»¿è‰²ï¼‰ï¼Œç‚¹å‡»ç¬¬äºŒä¸ªç‚¹è®¾ä¸ºç»ˆç‚¹ï¼ˆçº¢è‰²ï¼‰');
              
              let clickCount = 0;
              let startPoint = null, endPoint = null;
              
              function finishQuickSet() {
                map.off('click', onMapClick);
                if(window.geoLayer) window.geoLayer.eachLayer(l=>l.off('click', onMarkerClick));
                if(window.userMarkers) window.userMarkers.forEach(m=>m && m.off('click', onMarkerClick));
                isQuickSetting = false;
                quickSetBtn.textContent = 'ğŸ“ å¿«é€Ÿè®¾ç½®èµ·ç»ˆç‚¹';
                quickSetBtn.style.background = '#1976d2';
                if (tempStartMarker) tempStartMarker.closePopup();
                if (tempEndMarker) tempEndMarker.closePopup();
              }
              
              function handlePoint(latlng, isMarker) {
                if (clickCount === 0) {
                  startPoint = latlng;
                  if (tempStartMarker) map.removeLayer(tempStartMarker);
                  tempStartMarker = L.marker(startPoint, {
                    icon: L.divIcon({
                      className: 'start-marker',
                      html: '<div style="background:#009688;width:20px;height:20px;border-radius:50%;border:3px solid #fff;box-shadow:0 2px 6px rgba(0,0,0,0.3);"></div>',
                      iconSize: [20, 20],
                      iconAnchor: [10, 10]
                    })
                  }).addTo(map).bindPopup('èµ·ç‚¹').openPopup();
                  clickCount++;
                  setTimeout(() => {
                    if (tempStartMarker) {
                      tempStartMarker.closePopup();
                      tempStartMarker.bindPopup('èµ·ç‚¹å·²è®¾ç½®ï¼Œè¯·ç‚¹å‡»ç»ˆç‚¹').openPopup();
                    }
                  }, 1000);
                } else if (clickCount === 1) {
                  endPoint = latlng;
                  if (tempEndMarker) map.removeLayer(tempEndMarker);
                  tempEndMarker = L.marker(endPoint, {
                    icon: L.divIcon({
                      className: 'end-marker',
                      html: '<div style="background:#d32f2f;width:20px;height:20px;border-radius:50%;border:3px solid #fff;box-shadow:0 2px 6px rgba(0,0,0,0.3);"></div>',
                      iconSize: [20, 20],
                      iconAnchor: [10, 10]
                    })
                  }).addTo(map).bindPopup('ç»ˆç‚¹').openPopup();
                  clickCount++;
                  setTimeout(function() {
                    // æ–°å¢ï¼šé€‰æ‹©å‡ºè¡Œæ–¹å¼
                    showModeDialog(function(mode) {
                      if (confirm('èµ·ç»ˆç‚¹å·²è®¾ç½®å®Œæˆï¼\n\nèµ·ç‚¹ï¼š' + startPoint.lat.toFixed(6) + ', ' + startPoint.lng.toFixed(6) + '\nç»ˆç‚¹ï¼š' + endPoint.lat.toFixed(6) + ', ' + endPoint.lng.toFixed(6) + '\næœ¬è·¯å¾„ä¸º' + mode + 'çš„æ¨¡æ‹Ÿæœ€çŸ­ç›´çº¿ï¼Œä»…ä¾›å‚è€ƒã€‚\n\næ˜¯å¦ç”»å‡ºæœ€çŸ­è·¯å¾„ï¼Ÿ')) {
                        drawTempRouteLine(startPoint, endPoint, mode);
                      }
                      finishQuickSet();
                    });
                  }, 500);
                }
              }
              
              function onMapClick(e) { handlePoint(e.latlng, false); }
              function onMarkerClick(e) { L.DomEvent.stopPropagation(e); handlePoint(e.latlng, true); }
              
              map.on('click', onMapClick);
              if(window.geoLayer) window.geoLayer.eachLayer(l=>l.on('click', onMarkerClick));
              if(window.userMarkers) window.userMarkers.forEach(m=>m && m.on('click', onMarkerClick));
            };
          }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–å¿«é€Ÿè®¾ç½®æŒ‰é’®
        setTimeout(initQuickSetButton, 500);
        
        // åˆå§‹åŒ–æ¸…é™¤è·¯å¾„æŒ‰é’®
        function initClearRouteButton() {
          var clearRouteBtn = document.getElementById('clearRouteBtn');
          if (clearRouteBtn) {
            clearRouteBtn.onclick = function() {
              clearQuickRoute();
              if (roadPathLine) { map.removeLayer(roadPathLine); roadPathLine = null; }
              alert('è·¯å¾„å·²æ¸…é™¤');
            };
          }
        }
        
        setTimeout(initClearRouteButton, 500);
        
        // ä¼˜åŒ–ä¾§è¾¹æ æŒ‰é’®å’Œå›¾è¡¨é—´è·ï¼Œé¿å…é®æŒ¡
        var sidePanel = document.getElementById('side-panel');
        sidePanel.style.gap = '14px';
        // ç»Ÿä¸€æŒ‰é’®å®½åº¦å’Œåˆ†ç»„
        var btns = sidePanel.querySelectorAll('button');
        btns.forEach(function(btn){ 
          btn.style.width = '100%'; 
          btn.style.marginBottom = '10px'; 
        });

        // ========== å›¾ä¾‹æ§ä»¶ ========== //
        L.Control.Legend = L.Control.extend({
            options: { position: 'bottomleft' },
            onAdd: function(map) {
                var div = L.DomUtil.create('div', 'leaflet-control legend');
                div.innerHTML = `
                  <div class="legend-title">å›¾ä¾‹</div>
                  <div class="legend-item"><span class="legend-dot canteen"></span><span class="legend-label">é£Ÿå ‚</span></div>
                  <div class="legend-item"><span class="legend-dot dorm"></span><span class="legend-label">å®¿èˆ</span></div>
                  <div class="legend-item"><span class="legend-dot teach"></span><span class="legend-label">æ•™å­¦æ¥¼</span></div>
                  <div class="legend-item"><span class="legend-dot start-custom"></span><span class="legend-label">èµ·ç‚¹ï¼ˆæ·±ç»¿è‰²ï¼‰</span></div>
                  <div class="legend-item"><span class="legend-dot end-custom"></span><span class="legend-label">ç»ˆç‚¹ï¼ˆæ·±çº¢è‰²ï¼‰</span></div>
                  <div class="legend-item"><span class="legend-line"></span><span class="legend-label">è™šçº¿è·¯å¾„ï¼ˆç´«è‰²ï¼‰</span></div>
                  <div class="legend-item"><span style="display:inline-block;width:28px;height:0;border-top:4px solid #43a047;vertical-align:middle;margin:0 7px 0 0;"></span><span class="legend-label">æœ€çŸ­è·¯å¾„ï¼ˆç»¿è‰²ï¼‰</span></div>
                  <div class="legend-item"><span style="display:inline-block;width:16px;height:16px;border-radius:50%;background:#ffeb3b;border:3px solid #fbc02d;margin-right:7px;"></span><span class="legend-label">é€‰å€åˆ†æç‚¹ï¼ˆé»„è‰²ï¼‰</span></div>
                `;
                return div;
            }
        });
        map.addControl(new L.Control.Legend());

        // åŠ¨æ€æ˜¾ç¤ºæµ‹é‡è·ç¦»/é¢ç§¯ï¼ˆæ¯ä¸ªç‚¹å’Œæµ‹é‡å®Œæˆåå¼¹çª—ï¼‰
        function formatLength(m) {
          if (m < 1000) return m.toFixed(2) + ' ç±³';
          return (m / 1000).toFixed(3) + ' åƒç±³';
        }
        function formatArea(m2) {
          if (m2 < 10000) return m2.toFixed(2) + ' å¹³æ–¹ç±³';
          return (m2 / 10000).toFixed(3) + ' å…¬é¡·';
        }
        // æ¸…é™¤æ‰€æœ‰æµ‹é‡ä¸´æ—¶label
        function clearMeasureLabels() {
          map.eachLayer(function(layer) {
            if (layer._measureLabel) map.removeLayer(layer);
          });
        }
        // è·¯å¾„æ–¹å¼é€‰æ‹©å¼¹çª—é€»è¾‘
        function showModeDialog(callback) {
          const modal = document.getElementById('customModal');
          // åŠ¨æ€ç”Ÿæˆå†…å®¹
          document.getElementById('modalTitle').innerText = 'è¯·é€‰æ‹©å‡ºè¡Œæ–¹å¼';
          document.getElementById('modalBody').innerHTML = `
            <select id="modalType" style="font-size:15px;padding:8px 12px;border:1px solid #1976d2;border-radius:8px;margin-bottom:16px;outline:none;width:100%;max-width:220px;">
              <option value="æ­¥è¡Œ">æ­¥è¡Œ</option>
              <option value="éª‘è¡Œ">éª‘è¡Œ</option>
              <option value="å¼€è½¦">å¼€è½¦</option>
            </select>
          `;
          document.getElementById('modalFooter').innerHTML = `
            <button id="modalOk" class="modal-btn">ç¡®å®š</button>
            <button id="modalCancel" class="modal-btn cancel">å–æ¶ˆ</button>
          `;
          const select = document.getElementById('modalType');
          modal.style.display = 'flex';
          select.value = 'æ­¥è¡Œ';
          function close(result) {
            modal.style.display = 'none';
            document.getElementById('modalOk').onclick = null;
            document.getElementById('modalCancel').onclick = null;
            select.onkeydown = null;
            callback(result);
          }
          document.getElementById('modalOk').onclick = function() { close(select.value); };
          document.getElementById('modalCancel').onclick = function() { close(null); };
          select.onkeydown = function(e) {
            if (e.key === 'Enter') close(select.value);
            if (e.key === 'Escape') close(null);
          };
          select.focus();
        }

        // ========== åŠ è½½å¹¶æ˜¾ç¤ºæ ¡å›­é“è·¯ ========== //
        let roadData = null;
        let roadLayer = null;
        fetch('../data/Line_Export_Output.json')
          .then(res => res.json())
          .then(data => {
            roadData = data;
            roadLayer = L.geoJSON(data, {
              style: { color: '#1976d2', weight: 4, opacity: 0.7 }
            }).addTo(map);
          });

        // ========== è·¯ç½‘å»ºæ¨¡ä¸æœ€çŸ­è·¯å¾„ç®—æ³• ========== //
        // 1. è§£ææ‰€æœ‰LineStringä¸ºèŠ‚ç‚¹å’Œè¾¹
        function buildRoadGraph(roadData) {
          const nodes = [];
          const nodeMap = new Map(); // key: 'lng,lat' value: index
          const edges = [];
          function coordKey(coord) { return coord[0] + ',' + coord[1]; }
          // æ”¶é›†æ‰€æœ‰èŠ‚ç‚¹
          roadData.features.forEach(f => {
            let coords = f.geometry.coordinates;
            for (let i = 0; i < coords.length; i++) {
              let key = coordKey(coords[i]);
              if (!nodeMap.has(key)) {
                nodeMap.set(key, nodes.length);
                nodes.push(coords[i]);
              }
            }
          });
          // å»ºç«‹è¾¹
          roadData.features.forEach(f => {
            let coords = f.geometry.coordinates;
            for (let i = 0; i < coords.length - 1; i++) {
              let a = nodeMap.get(coordKey(coords[i]));
              let b = nodeMap.get(coordKey(coords[i+1]));
              let dist = turf.distance(turf.point(coords[i]), turf.point(coords[i+1]));
              edges.push({from: a, to: b, weight: dist});
              edges.push({from: b, to: a, weight: dist}); // æ— å‘
            }
          });
          // é‚»æ¥è¡¨
          const adj = Array(nodes.length).fill(0).map(() => []);
          edges.forEach(e => { adj[e.from].push({to: e.to, weight: e.weight}); });
          return {nodes, adj};
        }

        // 2. æ‰¾åˆ°æœ€è¿‘èŠ‚ç‚¹
        function findNearestNode(latlng, nodes) {
          let minDist = Infinity, idx = -1;
          for (let i = 0; i < nodes.length; i++) {
            let d = turf.distance(turf.point([latlng.lng, latlng.lat]), turf.point(nodes[i]));
            if (d < minDist) { minDist = d; idx = i; }
          }
          return idx;
        }

        // 3. Dijkstraæœ€çŸ­è·¯å¾„
        function dijkstra(adj, start, end) {
          const n = adj.length;
          const dist = Array(n).fill(Infinity);
          const prev = Array(n).fill(-1);
          const visited = Array(n).fill(false);
          dist[start] = 0;
          for (let i = 0; i < n; i++) {
            let u = -1;
            for (let j = 0; j < n; j++) {
              if (!visited[j] && (u === -1 || dist[j] < dist[u])) u = j;
            }
            if (dist[u] === Infinity) break;
            visited[u] = true;
            for (const e of adj[u]) {
              if (dist[e.to] > dist[u] + e.weight) {
                dist[e.to] = dist[u] + e.weight;
                prev[e.to] = u;
              }
            }
          }
          // å›æº¯è·¯å¾„
          let path = [];
          for (let at = end; at !== -1; at = prev[at]) path.push(at);
          path.reverse();
          if (path[0] !== start) return [];
          return path;
        }

        // ========== è·¯å¾„è§„åˆ’é›†æˆ ========== //
        let roadGraph = null;
        let roadPathLine = null;
        function showRoadPath(startLatLng, endLatLng) {
          if (!roadData) return;
          if (!roadGraph) roadGraph = buildRoadGraph(roadData);
          const {nodes, adj} = roadGraph;
          const startIdx = findNearestNode(startLatLng, nodes);
          const endIdx = findNearestNode(endLatLng, nodes);
          const pathIdx = dijkstra(adj, startIdx, endIdx);
          if (roadPathLine) { map.removeLayer(roadPathLine); roadPathLine = null; }
          if (pathIdx.length > 1) {
            const latlngs = pathIdx.map(i => [nodes[i][1], nodes[i][0]]); // [lat, lng]
            roadPathLine = L.polyline(latlngs, {color:'#43a047',weight:6,opacity:0.95}).addTo(map);
          }
        }

        // é€‰å€åˆ†æåŠŸèƒ½
        var siteAnalysisMode = false;
        var siteMarker = null;
        document.getElementById('siteAnalysisBtn').onclick = function() {
          if (siteAnalysisMode) return;
          siteAnalysisMode = true;
          this.innerText = 'è¯·åœ¨åœ°å›¾ä¸Šç‚¹é€‰å€™é€‰ç‚¹...';
          this.disabled = true;
          showCustomModal('é€‰å€åˆ†æ', 'è¯·åœ¨åœ°å›¾ä¸Šç‚¹å‡»ä¸€ä¸ªå€™é€‰ç‚¹ï¼Œç³»ç»Ÿå°†åˆ†æå…¶ä¸ä¸»è¦è®¾æ–½çš„ç©ºé—´å…³ç³»ã€‚');
          map.on('click', siteAnalysisClickHandler);
        };
        function siteAnalysisClickHandler(e) {
          var latlng = e.latlng;
          if (siteMarker) map.removeLayer(siteMarker);
          siteMarker = L.circleMarker(latlng, {
            radius: 12,
            fillColor: '#ffeb3b',
            color: '#fbc02d',
            weight: 3,
            opacity: 1,
            fillOpacity: 0.85
          }).addTo(map);
          // è®¡ç®—ä¸æ•™å­¦æ¥¼ã€å®¿èˆã€é£Ÿå ‚çš„æœ€è¿‘è·ç¦»
          var nearest = { 'æ•™å­¦æ¥¼': {dist: Infinity, name: ''}, 'å®¿èˆ': {dist: Infinity, name: ''}, 'é£Ÿå ‚': {dist: Infinity, name: ''} };
          if (window.geoLayer) {
            window.geoLayer.eachLayer(function(layer) {
              if (!layer.feature || !layer.feature.properties) return;
              var type = (function(feature) {
                const f8 = feature.properties && feature.properties.Field8 ? feature.properties.Field8 : '';
                if (f8.includes('é¤é¥®') || f8.includes('é£Ÿå ‚') || f8.includes('é¤å…')) return 'é£Ÿå ‚';
                if (f8.includes('å®¿èˆ')) return 'å®¿èˆ';
                if (f8.includes('æ•™å­¦æ¥¼') || f8.includes('å­¦æ ¡') || f8.includes('å›¾ä¹¦é¦†')) return 'æ•™å­¦æ¥¼';
                return 'å…¶ä»–';
              })(layer.feature);
              if (!nearest[type]) return;
              var ll = layer.getLatLng();
              var d = map.distance(latlng, ll);
              if (d < nearest[type].dist) {
                nearest[type].dist = d;
                nearest[type].name = layer.feature.properties.Field1 || '';
              }
            });
          }
          // ä¿å­˜åˆ†æç»“æœåˆ°markerå±æ€§ï¼Œä¾¿äºåç»­ç‚¹å‡»å¼¹çª—
          siteMarker.analysisInfo = {
            latlng: latlng,
            nearest: JSON.parse(JSON.stringify(nearest))
          };
          siteMarker.on('click', function() {
            showSiteAnalysisResult(this.analysisInfo);
          });
          showSiteAnalysisResult(siteMarker.analysisInfo);
          // é€€å‡ºæ¨¡å¼
          map.off('click', siteAnalysisClickHandler);
          siteAnalysisMode = false;
          document.getElementById('siteAnalysisBtn').innerText = 'é€‰å€åˆ†æ';
          document.getElementById('siteAnalysisBtn').disabled = false;
        }
        function showSiteAnalysisResult(info) {
          var latlng = info.latlng;
          var nearest = info.nearest;
          var html = '<div>å·²é€‰ç‚¹åæ ‡ï¼š<br>çº¬åº¦ ' + latlng.lat.toFixed(6) + '<br>ç»åº¦ ' + latlng.lng.toFixed(6) + '</div>';
          html += '<table style="margin-top:10px;font-size:15px;width:100%;text-align:left;">';
          html += '<tr><th>ç±»åˆ«</th><th>æœ€è¿‘è®¾æ–½</th><th>è·ç¦»</th></tr>';
          ['æ•™å­¦æ¥¼','å®¿èˆ','é£Ÿå ‚'].forEach(function(type) {
            html += '<tr><td>' + type + '</td><td>' + (nearest[type].name||'-') + '</td><td>' + (nearest[type].dist!==Infinity ? nearest[type].dist.toFixed(1)+'ç±³' : '-') + '</td></tr>';
          });
          html += '</table>';
          html += '<div style="text-align:right;margin-top:16px;"><button class="modal-btn" onclick="removeSiteMarker()">åˆ é™¤åˆ†æç‚¹</button><button class="modal-btn cancel" onclick="document.getElementById(\'customModal\').style.display=\'none\'">å…³é—­</button></div>';
          showCustomModal('é€‰å€åˆ†æç»“æœ', html, false);
        }
        window.removeSiteMarker = function() {
          if (siteMarker) { map.removeLayer(siteMarker); siteMarker = null; }
          document.getElementById('customModal').style.display = 'none';
        };
        // ä¿®æ”¹showCustomModalæ”¯æŒä¸è‡ªåŠ¨ç”Ÿæˆå…³é—­æŒ‰é’®
        function showCustomModal(title, body, autoCloseBtn) {
          document.getElementById('modalTitle').innerHTML = title;
          document.getElementById('modalBody').innerHTML = body;
          document.getElementById('customModal').style.display = 'flex';
          if (autoCloseBtn !== false) {
            document.getElementById('modalFooter').innerHTML = '<button class="modal-btn" onclick="document.getElementById(\'customModal\').style.display=\'none\'">å…³é—­</button>';
          } else {
            document.getElementById('modalFooter').innerHTML = '';
          }
        }
    </script>
</body>
</html>
